{% extends 'base.html' %}

{%block content%}
<div class="pure-g">
   <div class="pure-u-1 pure-u-md-1-5"></div>
   <div class="pure-u-1 pure-u-md-3-5">
      <h1>Timeline</h1>
   </div>
</div>
<div class="pure-g">
   <div class="pure-u-1 pure-u-md-1-5"></div>
   <div class="pure-u-1 pure-u-md-3-5">
      <div class="chart-wrapper-scroll" id="plotter">
      </div>
   </div>
   <div class="pure-u-1 pure-u-md-1-5"></div>
</div>
<div class="pure-g">
   <div class="pure-u-1 pure-u-sm-1-5"></div>
   <div class="pure-u-1 pure-u-sm-3-5"></div>
   <div class="pure-u-1 pure-u-sm-1-5"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

const MS_IN_DAY = 86400000;

//make our call to the server, then setup the plot
ajax({
   method: "get",
   url: "/timeline/data"
}).then(function(resp) {
   feeling_data = resp;
   setupPlot(feeling_data);
})

function setupPlot(data) {
   var trace = [];
   var trace_key = {};

   //-- making the feelings list available to javascript
   //-- also populate our chart with this to display them all
   let feelingList = [
      {% for i in feeling_axis %}
         "{{i}}",
      {% endfor %}
   ];

   let feelingColor = [
      {% for i in feeling_color %}
         "{{i}}",
      {% endfor %}
   ]

   //-- divide up our traces by feeling
   let j=0;
   feelingList.forEach(function(i){
      trace.push({
         x:[],
         y:[],
         type: 'scatter',
         marker: {"color": feelingColor[j], "size": 22},
         mode: "markers"
      });
      trace_key[i] = j;
      j++;
   });

   data.forEach(
      function(i){
         trace[trace_key[i.fields.feeling]].x.push(i.fields.date);
         trace[trace_key[i.fields.feeling]].y.push(i.fields.feeling);
         trace[trace_key[i.fields.feeling]].name="";
      }
   );
console.log(trace);

   var date = new Date();
   var date_ms = parseInt(date.getTime());

   var layout = {
      yaxis: {fixedrange: true, range: [0,feelingList.length-1]},
      xaxis: {fixedrange: false, scroll: true, scollZoom:false, type: 'date', range: [date_ms-MS_IN_DAY*10,date_ms+MS_IN_DAY], dtick:100000000},
   	dragmode: "pan",
      type: "scatter",
      mode: "markers",
      paper_bgcolor: "rgb(150,150,160)",
      plot_bgcolor: "rgb(150,150,160)",
      margin: {l:80, r:40, t:40},
      autosize: true,
      hovermode: 'closest',

   }

   // var trace1 = {
   //    x: [],
   //    y: [],
   //    type: 'scatter',
   //    marker: {"color": "#a0b0f0", "size": 22},
   //    mode: "markers"
   // }

   // {displayModeBar: true},
   PLOTTER = document.getElementById("plotter");
   	Plotly.newPlot( PLOTTER, trace,
      layout,

   );

   PLOTTER.on('plotly_click', function(data){
      data.points.map(function(d){
         console.log(d.x, d.y);
      })
   })
}

</script>
{%endblock%}
